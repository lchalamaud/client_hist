var idleTime=0,commercialPref="Tous",timeStepPref="",etatPref="",enCours=!0,oublie=!0,suspendu=!1,fin=!1,signe=!1,signEC=!1,etatFilter="En Cours|Oublié";function tabSelectVal(e,t){return e.cell(".selected",t).data()}function tacheFormat(e,t,a){var i=new Date;return a?'<table class="tacheTabClass" id="tacheTab'+e+'"><thead><tr><th>Type</th><th>Date</th><th class="spHide" colspan=2>Commercial</th><th></th></tr></thead><tbody><tr><td>Début</td><td class="centerCol">'+reorderDate(t)+'</td><td class="spHide tdColor"></td><td class="spHide centerCol">'+a+"</td><td></td></tr><tr><form><td><select id='type"+e+"' class=\"typeTacheSelect\"><option value='Appel'>Appel</option><option value='Démo'>Démo</option><option value='Propal'>Propal</option><option value='Rappel'>Rappel</option><option value='Sign EC'>Signature en cours</option><option value='Signature'>Signature</option><option value='Suspension'>Suspension</option><option value='Fin'>Fin</option></select></td><td class=\"centerCol\"><input type='date' id='dateTache"+e+"' value=\""+formatDate(i)+'"></td><td class="centerCol spHide" colspan=2><dl class="dropdown" id=\'selectComm'+e+'\'><dt>Cial<span class="fas fa-caret-down"></span></dt><dd><ul class="listcontent"></ul></dd></dl></td><td class="centerCol clickPlus"> <span class="plus">+</span></form></tr></tbody></table>':'<table class="tacheTabClass" id="tacheTab'+e+'"><thead><tr><th>Type</th><th>Date</th><th class="spHide" colspan=2>Cial</th><th></th></tr></thead><tbody><tr><td>Début</td><td class="centerCol">'+reorderDate(t)+'</td><td>Assign:</td><td class="centerCol spHide"><dl class="dropdown" id=\'selectComm'+e+'\'><dt>Cial<span class="fas fa-caret-down"></span></dt><dd><ul class="listcontent"></ul></dd></dl></td><td class="centerCol clickAssign"><span class="plus">+</span></td></tr></tbody></table>'}function infoFormat(e){return'<table class="infoTab spHide"><tr><td>'+(e.Civilite?e.Civilite:"")+"</td></tr><tr><td>"+(e.Rue?e.Rue:"")+"<br/>"+(e.Complement?e.Complement:"")+"<br/>"+(e.CP?e.CP:"")+" "+(e.Ville?e.Ville:"")+"</td></tr><tr><td>"+e.Mail+"</td></tr><tr><td>"+(e.Provenance?e.Provenance:"")+"</td></tr><tr><td>"+(e.Commentaire?e.Commentaire:"")+"</td></tr><tr><td>N° Dossier : "+(e.NumDossier?e.NumDossier:"")+"</td></tr></table>"}function reorderDate(e){return dateToken=e.split("-"),dateToken[2]+"-"+dateToken[1]+"-"+dateToken[0]}function sortDateTab(e,t){return e.date===t.date?0:e.date<t.date?-1:1}function formatDate(e){var t=e.getMonth()+1,a=e.getDate();return e.getFullYear()+"-"+(t<10?"0":"")+t+"-"+(a<10?"0":"")+a}function setTableInfo(e,t,a){t.cell(e,20).data(a)}function delstrpart(e,t){var a=e.indexOf(t);0==a&&a++;var i=e.substring(0,a-1)+e.substring(a+t.length);return!!i.length&&i}jQuery.fn.extend({isCheckSetFilter:function(e){$(this).is(":checked")?(0!=etatFilter?etatFilter+="|":etatFilter="",etatFilter+=e):etatFilter=delstrpart(etatFilter,e),setConfig()}}),jQuery.fn.dataTable.Api.register("page.jumpToData()",function(e,t){var a=this.column(t,{order:"current"}).data().indexOf(e);if(0<=a){var i=Math.floor(a/this.page.info().length);this.page(i).draw(!1)}return this}),$(document).ready(function(){initConfig(),disable("#delAffaireBtn"),disable("#modifAffaireBtn"),$.fn.dataTable.ext.search.push(function(e,t,a){var i=reorderDate(t[17]),n=s?reorderDate(s):"",r=o?reorderDate(o):"";return""==n&&""==r||""==n&&i<=r||n<=i&&""==r||n<=i&&i<=r}),jQuery.extend(jQuery.fn.dataTableExt.oSort,{"date-eu-pre":function(e){if(!(e=e.replace(" ","")))return 0;var t,a=e.split(/[\.\-\/]/);t=a[2]?a[2]:0;var i=a[1];1==i.length&&(i=0+i);var n=a[0];return 1==n.length&&(n=0+n),1*(t+i+n)},"date-eu-asc":function(e,t){return e<t?-1:t<e?1:0},"date-eu-desc":function(e,t){return e<t?1:t<e?-1:0}});var l=$(".client_Tab").DataTable({language:{sProcessing:"Traitement en cours...",sSearch:"Rechercher&nbsp;:",sLengthMenu:"Afficher _MENU_ &eacute;l&eacute;ments",sInfo:"_START_ - _END_ (pour _TOTAL_ affaires)",sInfoEmpty:"0 (pour 0 affaire)",sInfoFiltered:"",sInfoPostFix:"",sLoadingRecords:"Chargement en cours...",sZeroRecords:"Oups... Il semblerait qu'il n'y ait pas d'affaire.",sEmptyTable:"Oups... Il semblerait qu'il n'y ait pas d'affaire.",oPaginate:{sFirst:"Premier",sPrevious:"<<",sNext:">>",sLast:"Dernier"},oAria:{sSortAscending:": activer pour trier la colonne par ordre croissant",sSortDescending:": activer pour trier la colonne par ordre d&eacute;croissant"}},columns:[{className:"details-control",orderable:!1,data:null,defaultContent:"",render:function(){return'<i class="fa fa-plus" aria-hidden="true"></i>'},width:"15px"},{data:"etat",orderable:!1,render:function(e,t,a,i){switch(e){case"En Cours":img='<img src="/images/blue.jpg" class="colorSquare">';break;case"Oublié":img='<img src="/images/yellow.jpg" class="colorSquare">';break;case"Signé":img='<img src="/images/green.jpg" class="colorSquare">';break;case"Sign EC":img='<img src="/images/green_2.jpg" class="colorSquare">';break;case"Suspendu":img='<img src="/images/orange.jpg" class="colorSquare">';break;case"Fin":img='<img src="/images/red.jpg" class="colorSquare">'}return img}},{data:"Civilite",visible:!1},{data:"Nom"},{data:"Societe"},{data:"Rue",visible:!1},{data:"Complement",visible:!1},{data:"CP",visible:!1},{data:"Ville"},{data:"Mail",visible:!1},{data:"Telephone"},{data:"Nb_Controller"},{data:"Devi_Type"},{data:"System_Type"},{data:"Provenance",visible:!1},{data:"Debut",visible:!1},{data:"Etat",visible:!1},{data:"Rappel",width:"10%",render:function(e,t,a,i){return reorderDate(e)},type:"date-eu"},{data:"Commercial",width:"9%"},{data:"Commentaire",visible:!1},{data:"Info",visible:!1},{data:"NumDossier",visible:!1},{data:"Id",visible:!1}],pageLength:Math.trunc((window.innerHeight-$("#header").height()-100)/45),order:[[17,"desc"]],dom:'tpr<"top"i>',autoWidth:!1,initComplete:function(){this.api().columns(18).every(function(){var t=this,a=$('<select class="selector"><option value="">Tous</option></select>').appendTo("#commercialSelect").on("change",function(){var e=$.fn.dataTable.util.escapeRegex($(this).val());t.search(e?"^"+e+"$":"",!0,!1).draw()});t.data().unique().sort().each(function(e,t){a.append('<option value="'+e.slice(84)+'">'+e.slice(84)+"</option>")});var e=commercialPref;a.val(e),t.search(e).draw()})}});$("#waiter").remove(),$("#affaireDetail").show();var s="",o="";timePref=setTimeStep(timeStepPref),s=timePref.min,o=timePref.max,setInitStateConfig(),l.column(16).search(etatFilter,!0,!1),l.draw(),$("#modifAffaireBtn").on("click",function(){fillForm(l)}),$("#modifConfirmBtn").on("click",function(){modifAffaire(l,tabSelectVal(l,22))}),$("#delAffaireBtn").on("click",function(){$("#delModalNom").empty().prepend(l.cell(".selected",3).data()),$("#delModalSociete").empty().prepend(l.cell(".selected",4).data())}),$("#delConfirmBtn").on("click",function(){delAffaire(l.cell(".selected",22).data(),l)}),$(".stateCheckbox").click(function(){switch($(this).attr("id")){case"cbEnCours":$(this).isCheckSetFilter("En Cours");break;case"cbOublie":$(this).isCheckSetFilter("Oublié");break;case"cbFin":$(this).isCheckSetFilter("Fin");break;case"cbSuspendu":$(this).isCheckSetFilter("Suspendu");break;case"cbSignEC":$(this).isCheckSetFilter("Sign EC");break;case"cbSigne":$(this).isCheckSetFilter("Signé")}l.column(16).search(etatFilter,!0,!1).draw()}),$("#timeSelect").change(function(){timePref=setTimeStep($(this).val()),s=timePref.min,o=timePref.max,console.log("de "+s+" à "+o),l.draw(),setConfig()}),$("#searchbox").keyup(function(){l.search($(this).val()).draw()}),$("#commercialSelect select, #etatSelect select").change(function(){setConfig()}),$(document).on("click",".client_Tab tbody tr",function(){$(this).hasClass("selected")?(disable("#delAffaireBtn"),disable("#modifAffaireBtn"),$(this).removeClass("selected")):$(this).parents(".infoLine").length||$(this).hasClass("infoLine")||(l.$("tr.selected").removeClass("selected"),enable("#delAffaireBtn"),enable("#modifAffaireBtn"),$(this).addClass("selected"))}),$(".client_Tab tbody").on("click","td.details-control",function(){var e=$(this).closest("tr"),t=e.find("i.fa"),a=l.row(e),i=l.cell(this,22).data(),n=l.cell(this,15).data(),r=l.cell(this,18).data().slice(84);if(a.child.isShown())$("div.slider",a.child()).slideUp(function(){a.child().removeClass("infoLine"),a.child.hide(),e.removeClass("shown")}),t.first().removeClass("fa-minus"),t.first().addClass("fa-plus"),$("#infoArea"+i).remove();else{a.child("<div class='slider'>"+tacheFormat(i,n,r)+infoFormat(a.data())+'<div class="infoText" id="infoArea'+i+'"><textarea>'+(l.cell(this,20).data()?l.cell(this,20).data():"")+"</textarea></div></div>").show(),getTacheCommercial(i,r),a.child().addClass("infoLine"),e.addClass("shown"),t.first().removeClass("fa-plus"),t.first().addClass("fa-minus"),$("div.slider",a.child()).slideDown();var s=$("#infoArea"+i).width();$("#infoArea"+i).css({right:-(s+10)+"px"})}}),$(document).on("change",".typeTacheSelect",function(){var e=event.target.id.slice(4);"Signature"==$(event.target).find(":selected").val()?($("<tr class='numDossier"+e+"'><td>N° Dossier :</td><td class='centerCol'><input type='number' class='numDossierInput'></td><td colspan=3></td></tr>").appendTo($(event.target.parentElement.parentElement.parentElement)),$("tbody .numDossier"+e).find("td").wrapInner('<div style="display: none;" />').parent().find("td > div").slideDown("fast",function(){var e=$(this);e.replaceWith(e.contents())}),$(event.target.parentElement).addClass("Signature")):$(event.target.parentElement).hasClass("Signature")&&($(event.target.parentElement).removeClass("Signature"),$("tbody .numDossier"+e).find("td").wrapInner('<div style="display: block;" />').parent().find("td > div").slideUp("fast",function(){$(this).parent().parent().remove()}))}),$(document).on("click",".clickAssign",function(){var e=$(this).closest("tr.infoLine").prev(),t=l.cell(e,22).data(),a=$("#selectComm"+t+" dt").html().split("</span>");a?setCommercial(l,t,e,a[1],a[0]+"</span>"):($("#selectComm"+t).fadeTo(400,.33).fadeTo(400,1).fadeTo(400,.33).fadeTo(400,1),alert("Veuillez rentrer le commercial à assigner à l'affaire."))}),$(document).on("click",".clickPlus",function(){var e=$(this).closest("tr.infoLine").prev(),t=l.cell(e,22).data();$("#dateTache"+t).val()?"Signature"==$("#type"+t+" option:selected").val()?(numDossier=$(event.target.parentElement.parentElement).next().find(".numDossierInput").val(),numDossier?addTache(t,e,l,numDossier):alert("Veuillez rentrer le numéros de dossier")):addTache(t,e,l,null):alert("Veuillez rentrer une date")}),$(".client_Tab").on("click",".fa-times-circle",function(){var e=event.target.id.slice(5),t=event.target.parentElement.parentElement,a=$(this).closest("tr.infoLine").prev();delTache(e,t,l,a)}),$(document).on("change","div.infoText textarea",function(e){var t=$(this).closest("tr"),a=(l.row(t),$(this).closest("tr.infoLine").prev()),i=e.target.parentElement.id.slice(8);setAffaireInfo(i,a,l,$("#infoArea"+i+" textarea").val())}),setInterval(function(){updateTable(l)},3e5)});