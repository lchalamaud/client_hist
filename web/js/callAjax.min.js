function delAffaire(e,t){var a="/del/affaire/"+e+"/";$.ajax({type:"post",url:a,beforeSend:function(){$("#delConfirmBtn").prop("disabled",!0),$("html").css("cursor","wait"),$("#delResponse").empty().append('<p style="color: grey;margin-left:10px;">Suppression en cours...</p>')},success:function(){$("html").css("cursor","default"),$("#delResponse").empty(),document.getElementById("delAffaireModal").style.display="none",t.row(".selected").remove().draw(),disable("#delAffaireBtn"),disable("#modifAffaireBtn"),$("#delConfirmBtn").prop("disabled",!1)},error:function(){$("#delResponse").empty().append('<p style="color: red;margin-left:10px;">Erreur dans la suppression de l affaire.</p>'),$("html").css("cursor","default"),$("#delConfirmBtn").prop("disabled",!1)}})}function setCommercial(a,o,r,l){var n=new Date;$.ajax({type:"post",url:"/commercial/set/",beforeSend:function(){},success:function(e){a.cell(l,18).data(r),$("#selectComm"+o).closest("tbody").append("<tr><form><td><select id='type"+o+"' class=\"typeTacheSelect\"><option value='Appel'>Appel</option><option value='Démo'>Démo</option><option value='Propal'>Propal</option><option value='Rappel'>Rappel</option><option value='Sign EC'>Signature en cours</option><option value='Signature'>Signature</option><option value='Suspension'>Suspension</option><option value='Fin'>Fin</option></select></td><td class=\"centerCol\"><input type='date' id='dateTache"+o+"' value=\""+formatDate(n)+'"></td><td class="centerCol spHide newTaskTab" colspan=2></td><td class="centerCol clickPlus"> <span class="plus">+</span></form></tr>');var t=$("#selectComm"+o).clone();$(".newTaskTab").append(t).removeClass("newTaskTab"),$("#selectComm"+o).closest("td").empty().append(r)},error:function(){},data:{idAffaire:o,commercial:r}})}function getTacheCommercial(a,o){$.ajax({type:"get",url:"/tache/affaire/nom/",beforeSend:function(){$("html").css("cursor","wait")},success:function(e){$("html").css("cursor","default"),$.each(e.commercial,function(e,t){t.acronyme==o?$("#selectComm"+a).append('<option value="'+t.acronyme+'" style="background-color: '+t.couleur+';"selected>'+t.acronyme+"</option>"):$("#selectComm"+a).append('<option value="'+t.acronyme+'" style="background-color: '+t.couleur+';"><span class="colorSquare blockColorSquare" style="background-color: '+t.couleur+';"></span> '+t.acronyme+"</option>")}),e.taches.sort(sortDateTab),$.each(e.taches,function(e,t){$("#tacheTab"+a).prepend("<tr><td>"+t.type+'</td><td class="centerCol">'+reorderDate(t.date)+'</td><td class="centerCol tdColor"><span class="colorSquare blockColorSquare" style="background-color: '+t.couleur+';"></span></td><td class="centerCol spHide">'+t.commercial+'</td><td class="centerCol spHide"><i class="far fa-times-circle" id="cross'+t.id+'"></i></td></td>')})},error:function(){$("html").css("cursor","default"),$("#tacheTab"+a).prepend('<tr><td colspan=5 style="color : red">Erreur de lecture... Fermez et réouvrez l\'affaire</td></tr>')},data:{idAffaire:a}})}function addTache(r,l,n,e){type=$("#type"+r).val(),date=reorderDate($("#dateTache"+r).val()),commercial=$("#selectComm"+r).find(":selected").val(),tache={idAffaire:r,type:type,date:date,commercial:commercial,numDossier:e};$.ajax({type:"post",url:"/add/tache/",beforeSend:function(){},success:function(e){0<=$("#tacheTab"+r+" tr td").text().indexOf("Aucune tache associée à cette affaire")&&$("#emptyLine"+r).remove(),$("#tacheTab"+r+" tbody").prepend("<tr><td>"+type+'</td><td class="centerCol">'+date+'</td><td class="centerCol tdColor"><span class="colorSquare blockColorSquare" style="background-color: '+e.couleur+';"></span></td><td class="centerCol spHide">'+commercial+'</td><td class="centerCol spHide"><i class="far fa-times-circle" id="cross'+e.id+'"></i></td></tr>');var t=$("#infoArea"+r+" textarea").val();$("#infoArea"+r+" textarea").val(type+", "+date+" ("+commercial+"):\n\n"+t),n.cell(l,20).data(type+", "+date+" ("+commercial+"):\n\n"+t);var a=new Date,o=formatDate(a).split("-");switch(type){case"Signature":n.cell(l,1).data("Signé"),n.cell(l,16).data("Signé"),$("tbody .numDossier"+r).find("td").wrapInner('<div style="display: block;" />').parent().find("td > div").slideUp("fast",function(){$(this).parent().parent().remove()});break;case"Suspension":n.cell(l,1).data("Suspendu"),n.cell(l,16).data("Suspendu");break;case"Fin":n.cell(l,1).data("Fin"),n.cell(l,16).data("Fin");break;case"Sign EC":n.cell(l,1).data("Sign EC"),n.cell(l,16).data("Sign EC");break;case"Rappel":reorderDate(date)>n.cell(l,17).data()&&n.cell(l,17).data(reorderDate(date)),reorderDate(date)<o[0]+"-"+o[1]+"-"+o[2]?(n.cell(l,1).data("Oublié"),n.cell(l,16).data("Oublié")):(n.cell(l,1).data("En Cours"),n.cell(l,16).data("En Cours"));break;default:reorderDate(date)<o[0]+"-"+o[1]+"-"+o[2]?(n.cell(l,1).data("Oublié"),n.cell(l,16).data("Oublié")):(n.cell(l,1).data("En Cours"),n.cell(l,16).data("En Cours"))}},error:function(){$("#debug").css("color","red")},data:tache})}function delTache(e,t,a,o){$.ajax({type:"post",url:"/del/tache/",beforeSend:function(){for(i=0;i<3;i++)$(t).fadeTo(400,.33).fadeTo(400,1)},success:function(){"TR"!=$(t).prev().prop("nodeName")&&(prevDate=reorderDate($(t).next().find(".spHide").prev().text()),a.cell(o,17).data(prevDate)),$(t).remove()},error:function(){},data:{idTache:e}})}function modifAffaire(t,e){jsonAffaire=getFormVal(e);$.ajax({type:"POST",url:"/modif/affaire/",dataType:"json",beforeSend:function(){$("html").css("cursor","wait")},success:function(e){$("html").css("cursor","default"),$("#addAffaireModal").css("display","none"),updateTableVal(t,jsonAffaire)},error:function(){$("html").css("cursor","default"),$("#debug").css("color","red"),debug("Une erreur est survenue lors de l'envoie des données. Les paramètres précedent ont été conservé.")},data:jsonAffaire})}function setAffaireInfo(e,t,a,o){JsonInfo={idAffaire:e,info:o};$.ajax({type:"POST",url:"/set/info/",dataType:"json",beforeSend:function(){$("html").css("cursor","wait")},success:function(e){$("html").css("cursor","default"),setTableInfo(t,a,o)},error:function(){$("html").css("cursor","not-allowed"),delay(function(){$("html").css("cursor","default")},2e3)},data:JsonInfo})}function isNotShown(a,o){var r=!0;return idList=a.cells(".shown",22)[0],$.each(idList,function(e,t){if(o==a.cell(t).data())return r=!1}),r}function updateTable(a){$.ajax({type:"GET",url:"/affaire/get/",beforeSend:function(){},success:function(e){var t=tabSelectVal(a,22);a.rows(":not(.shown)").remove(),$.each(e.affaires,function(e,t){isNotShown(a,t.id)&&(tmp={"":null,etat:t.etat,Civilite:t.civilite,Nom:t.nom,Societe:t.societe,Rue:t.rue,Complement:t.complement,CP:t.cp,Ville:t.ville,Mail:t.mail,Telephone:t.telephone,Nb_Controller:t.nb_controller,Devi_Type:t.devi_type,System_Type:t.system_type,Provenance:t.provenance,Debut:t.debut,Etat:t.etat,Rappel:t.rappel,Commercial:t.commercial,Commentaire:t.commentaire,Info:t.info,NumDossier:t.numDossier,Id:t.id},rows=a.rows.add([tmp]).nodes(),td=$(rows).find("td"),td.eq(0).addClass("centerCol"),td.eq(1).addClass("centerCol"),td.eq(5).addClass("centerCol"),td.eq(6).addClass("centerCol"),td.eq(9).addClass("centerCol"),td.eq(10).addClass("centerCol cialCol"))}),a.draw(),a.page.jumpToData(t,22)},error:function(){}})}