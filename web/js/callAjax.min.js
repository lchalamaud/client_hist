function delAffaire(e,a){var t="/del/affaire/"+e+"/";$.ajax({type:"post",url:t,beforeSend:function(){$("#delConfirmBtn").prop("disabled",!0),$("html").css("cursor","wait"),$("#delResponse").empty().append('<p style="color: grey;margin-left:10px;">Suppression en cours...</p>')},success:function(){$("html").css("cursor","default"),$("#delResponse").empty(),document.getElementById("delAffaireModal").style.display="none",a.row(".selected").remove().draw(),disable("#delAffaireBtn"),disable("#modifAffaireBtn"),$("#delConfirmBtn").prop("disabled",!1)},error:function(){$("#delResponse").empty().append('<p style="color: red;margin-left:10px;">Erreur dans la suppression de l affaire.</p>'),$("html").css("cursor","default"),$("#delConfirmBtn").prop("disabled",!1)}})}function setCommercial(t,o,l,r,s){var c=new Date;$.ajax({type:"post",url:"/commercial/set/",beforeSend:function(){$("#selectComm"+o).closest("td").next().removeClass("clickAssign")},success:function(e){t.cell(l,18).data('<span class="colorSquare blockColorSquare" style="background-color:'+e.couleur+';"></span>'+r),$("#selectComm"+o).closest("tbody").append("<tr><form><td><select id='type"+o+"' class=\"typeTacheSelect\"><option value='Appel'>Appel</option><option value='Démo'>Démo</option><option value='Propal'>Propal</option><option value='Rappel'>Rappel</option><option value='Sign EC'>Signature en cours</option><option value='Signature'>Signature</option><option value='Suspension'>Suspension</option><option value='Fin'>Fin</option></select></td><td class=\"centerCol\"><input type='date' id='dateTache"+o+"' value=\""+formatDate(c)+'"></td><td class="centerCol spHide newTaskTab" colspan=2></td><td class="centerCol clickPlus"> <span class="plus">+</span></form></tr>');var a=$("#selectComm"+o).clone();$(".newTaskTab").append(a).removeClass("newTaskTab"),$("#selectComm"+o).closest("td").next().empty(),$("#selectComm"+o).closest("td").prev().empty().append(s),$("#selectComm"+o).closest("td").empty().append(r)},error:function(){$("#selectComm"+o).closest("td").next().addClass("clickAssign")},data:{idAffaire:o,commercial:r}})}function getTacheCommercial(t,o){$.ajax({type:"get",url:"/tache/affaire/nom/",beforeSend:function(){$("html").css("cursor","wait")},success:function(e){$("html").css("cursor","default"),$.each(e.commercial,function(e,a){$("#selectComm"+t+" .listcontent").append('<li><span class="colorSquare blockColorSquare" style="background-color:'+a.couleur+';"></span>'+a.acronyme+"</li>"),a.acronyme==o&&($("#selectComm"+t+" dt").empty().append('<span class="colorSquare blockColorSquare" style="background-color:'+a.couleur+';"></span>'+a.acronyme),$("#selectComm"+t+" dt").closest("tr").prev().find(".tdColor").empty().append('<span class="colorSquare blockColorSquare" style="background-color:'+a.couleur+';"></span>'))}),e.taches.sort(sortDateTab),$.each(e.taches,function(e,a){$("#tacheTab"+t).prepend("<tr><td>"+a.type+'</td><td class="centerCol">'+reorderDate(a.date)+'</td><td class="centerCol tdColor"><span class="colorSquare blockColorSquare" style="background-color: '+a.couleur+';"></span></td><td class="centerCol spHide">'+a.commercial+'</td><td class="centerCol spHide"><i class="far fa-times-circle" id="cross'+a.id+'"></i></td></td>')})},error:function(){$("html").css("cursor","default"),$("#tacheTab"+t).prepend('<tr><td colspan=5 style="color : red">Erreur de lecture... Fermez et réouvrez l\'affaire</td></tr>')},data:{idAffaire:t}})}function addTache(l,r,s,e){type=$("#type"+l).val(),date=reorderDate($("#dateTache"+l).val()),commercial=$("#selectComm"+l+" dt").html().split("</span>")[1],tache={idAffaire:l,type:type,date:date,commercial:commercial,numDossier:e};$.ajax({type:"post",url:"/add/tache/",beforeSend:function(){$("#selectComm"+l).closest("td").next().removeClass("clickPlus")},success:function(e){0<=$("#tacheTab"+l+" tr td").text().indexOf("Aucune tache associée à cette affaire")&&$("#emptyLine"+l).remove(),$("#tacheTab"+l+" tbody").prepend("<tr><td>"+type+'</td><td class="centerCol">'+date+'</td><td class="centerCol tdColor"><span class="colorSquare blockColorSquare" style="background-color: '+e.couleur+';"></span></td><td class="centerCol spHide">'+commercial+'</td><td class="centerCol spHide"><i class="far fa-times-circle" id="cross'+e.id+'"></i></td></tr>');var a=$("#infoArea"+l+" textarea").val();$("#infoArea"+l+" textarea").val(type+", "+date+" ("+commercial+"):\n\n"+a),s.cell(r,20).data(type+", "+date+" ("+commercial+"):\n\n"+a);var t=new Date,o=formatDate(t).split("-");switch(type){case"Signature":s.cell(r,1).data("Signé"),s.cell(r,16).data("Signé"),$("tbody .numDossier"+l).find("td").wrapInner('<div style="display: block;" />').parent().find("td > div").slideUp("fast",function(){$(this).parent().parent().remove()});break;case"Suspension":s.cell(r,1).data("Suspendu"),s.cell(r,16).data("Suspendu");break;case"Fin":s.cell(r,1).data("Fin"),s.cell(r,16).data("Fin");break;case"Sign EC":s.cell(r,1).data("Sign EC"),s.cell(r,16).data("Sign EC");break;case"Rappel":reorderDate(date)>s.cell(r,17).data()&&s.cell(r,17).data(reorderDate(date)),reorderDate(date)<o[0]+"-"+o[1]+"-"+o[2]?(s.cell(r,1).data("Oublié"),s.cell(r,16).data("Oublié")):(s.cell(r,1).data("En Cours"),s.cell(r,16).data("En Cours"));break;default:reorderDate(date)<o[0]+"-"+o[1]+"-"+o[2]?(s.cell(r,1).data("Oublié"),s.cell(r,16).data("Oublié")):(s.cell(r,1).data("En Cours"),s.cell(r,16).data("En Cours"))}$("#selectComm"+l).closest("td").next().addClass("clickPlus")},error:function(){$("#debug").css("color","red"),$("#selectComm"+l).closest("td").next().addClass("clickPlus")},data:tache})}function delTache(e,l,r,s){$.ajax({type:"post",url:"/del/tache/",beforeSend:function(){for(i=0;i<3;i++)$(l).fadeTo(400,.33).fadeTo(400,1)},success:function(){if("TR"!=$(l).prev().prop("nodeName")){var e=reorderDate($(l).next().find(".tdColor").prev().text());r.cell(s,17).data(e);var a=$(l).next().find("td").first().text(),t=new Date,o=formatDate(t).split("-");switch(a){case"Signature":r.cell(s,1).data("Signé"),r.cell(s,16).data("Signé");break;case"Suspension":r.cell(s,1).data("Suspendu"),r.cell(s,16).data("Suspendu");break;case"Fin":r.cell(s,1).data("Fin"),r.cell(s,16).data("Fin");break;case"Sign EC":r.cell(s,1).data("Sign EC"),r.cell(s,16).data("Sign EC");break;default:console.log(e+" < "+o[0]+"-"+o[1]+"-"+o[2]),e<o[0]+"-"+o[1]+"-"+o[2]?(r.cell(s,1).data("Oublié"),r.cell(s,16).data("Oublié")):(r.cell(s,1).data("En Cours"),r.cell(s,16).data("En Cours"))}}$(l).remove()},error:function(){},data:{idTache:e}})}function modifAffaire(a,e){jsonAffaire=getFormVal(e);$.ajax({type:"POST",url:"/modif/affaire/",dataType:"json",beforeSend:function(){$("html").css("cursor","wait")},success:function(e){$("html").css("cursor","default"),$("#addAffaireModal").css("display","none"),updateTableVal(a,jsonAffaire,e.color)},error:function(){$("html").css("cursor","default"),$("#debug").css("color","red"),debug("Une erreur est survenue lors de l'envoie des données. Les paramètres précedent ont été conservé.")},data:jsonAffaire})}function setAffaireInfo(e,a,t,o){JsonInfo={idAffaire:e,info:o};$.ajax({type:"POST",url:"/set/info/",dataType:"json",beforeSend:function(){$("html").css("cursor","wait")},success:function(e){$("html").css("cursor","default"),setTableInfo(a,t,o)},error:function(){$("html").css("cursor","not-allowed"),delay(function(){$("html").css("cursor","default")},2e3)},data:JsonInfo})}function isNotShown(t,o){var l=!0;return idList=t.cells(".shown",22)[0],$.each(idList,function(e,a){if(o==t.cell(a).data())return l=!1}),l}function updateTable(t){$.ajax({type:"GET",url:"/affaire/get/",beforeSend:function(){},success:function(e){var a=tabSelectVal(t,22);t.rows(":not(.shown)").remove(),$.each(e.affaires,function(e,a){isNotShown(t,a.id)&&(tmp={"":null,etat:a.etat,Civilite:a.civilite,Nom:a.nom,Societe:a.societe,Rue:a.rue,Complement:a.complement,CP:a.cp,Ville:a.ville,Mail:a.mail,Telephone:a.telephone,Nb_Controller:a.nb_controller,Devi_Type:a.devi_type,System_Type:a.system_type,Provenance:a.provenance,Debut:a.debut,Etat:a.etat,Rappel:a.rappel,Commercial:a.commercialCouleur?'<span class="colorSquare blockColorSquare" style="background-color:'+a.commercialCouleur+';"></span>'+a.commercialAcronyme:"",Commentaire:a.commentaire,Info:a.info,NumDossier:a.numDossier,Id:a.id},rows=t.rows.add([tmp]).nodes(),td=$(rows).find("td"),td.eq(0).addClass("centerCol"),td.eq(1).addClass("centerCol"),td.eq(5).addClass("centerCol"),td.eq(6).addClass("centerCol"),td.eq(9).addClass("centerCol"),td.eq(10).addClass("centerCol cialCol"))}),t.draw(),t.page.jumpToData(a,22)},error:function(){}})}